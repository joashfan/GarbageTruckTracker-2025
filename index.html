<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣垃圾車即時動態 (Debug版)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .leaflet-div-icon { background: transparent; border: none; }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        day: { bg: '#f3f4f6', card: '#ffffff', text: '#1f2937' },
                        night: { bg: '#111827', card: '#1f2937', text: '#f3f4f6' }
                    }
                }
            }
        }
    </script>
</head>
<body class="transition-colors duration-500">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Configuration Data ---
        const PROXY_BASE = 'https://garbageproxy-20251128.zeabur.app/api/proxy';

        const CITIES = [
            { id: 'keelung', name: '基隆市', lat: 25.1276, lng: 121.7392, type: 'csv', url: `${PROXY_BASE}?city=keelung` },
            { id: 'taipei', name: '臺北市', lat: 25.0330, lng: 121.5654, type: 'csv', url: `${PROXY_BASE}?city=taipei` },
            { id: 'new_taipei', name: '新北市', lat: 25.0170, lng: 121.4625, type: 'csv', url: `${PROXY_BASE}?city=new_taipei` },
            { id: 'taichung', name: '臺中市', lat: 24.1477, lng: 120.6736, type: 'json', url: `${PROXY_BASE}?city=taichung` },
            { id: 'changhua', name: '彰化市', lat: 24.0518, lng: 120.5461, type: 'web', url: 'https://hwms.moenv.gov.tw/dispPageBox/route/routeCP.aspx?ddsPageID=LINEINFO&dbid=6591326671' }, 
            { id: 'tainan', name: '臺南市', lat: 22.9997, lng: 120.2270, type: 'csv', url: `${PROXY_BASE}?city=tainan` },
            { id: 'kaohsiung', name: '高雄市', lat: 22.6273, lng: 120.3014, type: 'json', url: `${PROXY_BASE}?city=kaohsiung` },
            { id: 'yilan', name: '宜蘭縣', lat: 24.7021, lng: 121.7377, type: 'json', url: `${PROXY_BASE}?city=yilan` },
        ];

        // --- Icons & Helpers ---
        const generateMockTrucks = (city, count = 10) => {
            const trucks = [];
            for (let i = 0; i < count; i++) {
                trucks.push({
                    id: `mock-${i}`,
                    plate: `GPS-${1000 + i}`,
                    location: `模擬路線 ${i+1}號`,
                    lat: city.lat + (Math.random() - 0.5) * 0.05,
                    lng: city.lng + (Math.random() - 0.5) * 0.05,
                    angle: Math.random() * 360
                });
            }
            return trucks;
        };

        const moveMockTrucks = (trucks) => {
            return trucks.map(t => ({
                ...t,
                lat: t.lat + (Math.random() - 0.5) * 0.001,
                lng: t.lng + (Math.random() - 0.5) * 0.001
            }));
        };

        // --- Main Component ---
        const App = () => {
            const [darkMode, setDarkMode] = useState(false);
            const [selectedCity, setSelectedCity] = useState(null);
            const [trucks, setTrucks] = useState([]);
            const [loading, setLoading] = useState(false);
            const [useRealData, setUseRealData] = useState(false);
            const [activeTruckId, setActiveTruckId] = useState(null);
            const [debugMsg, setDebugMsg] = useState('');
            
            const mapInstanceRef = useRef(null);
            const markersRef = useRef({});
            const tileLayerRef = useRef(null);

            // Time check
            useEffect(() => {
                const checkTime = () => {
                    const hour = new Date().getHours();
                    setDarkMode(hour < 6 || hour >= 18);
                };
                checkTime();
            }, []);

            // Theme effect
            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                
                if (mapInstanceRef.current && tileLayerRef.current) {
                    const tileUrl = darkMode 
                        ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                        : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                    tileLayerRef.current.setUrl(tileUrl);
                }
            }, [darkMode]);

            // Mock Simulation
            useEffect(() => {
                if (!selectedCity || useRealData) return;
                const interval = setInterval(() => setTrucks(prev => moveMockTrucks(prev)), 2000);
                return () => clearInterval(interval);
            }, [selectedCity, useRealData]);

            // Map Init
            useEffect(() => {
                if (selectedCity && !mapInstanceRef.current) {
                    mapInstanceRef.current = L.map('map-container').setView([selectedCity.lat, selectedCity.lng], 13);
                    const tileUrl = darkMode 
                        ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                        : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                    tileLayerRef.current = L.tileLayer(tileUrl, {
                        attribution: '&copy; OpenStreetMap', subdomains: 'abcd', maxZoom: 19
                    }).addTo(mapInstanceRef.current);
                }
                if (!selectedCity && mapInstanceRef.current) {
                    mapInstanceRef.current.remove();
                    mapInstanceRef.current = null;
                    markersRef.current = {};
                }
            }, [selectedCity]);

            // Markers Update
            useEffect(() => {
                if (!mapInstanceRef.current) return;
                const map = mapInstanceRef.current;
                const currentMarkers = markersRef.current;
                const newIds = new Set(trucks.map(t => t.id));

                Object.keys(currentMarkers).forEach(id => {
                    if (!newIds.has(id)) {
                        map.removeLayer(currentMarkers[id]);
                        delete currentMarkers[id];
                    }
                });

                trucks.forEach(truck => {
                    const iconHtml = `<div style="font-size: 24px; color: ${truck.id === activeTruckId ? '#e11d48' : '#10b981'}; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"><i class="fa-solid fa-truck-field"></i></div>`;
                    const customIcon = L.divIcon({ html: iconHtml, className: 'leaflet-div-icon', iconSize: [30, 30], iconAnchor: [15, 15] });

                    if (currentMarkers[truck.id]) {
                        currentMarkers[truck.id].setLatLng([truck.lat, truck.lng]).setIcon(customIcon);
                    } else {
                        const marker = L.marker([truck.lat, truck.lng], { icon: customIcon })
                            .addTo(map)
                            .bindPopup(`<b>${truck.plate}</b><br>${truck.location}`)
                            .on('click', () => setActiveTruckId(truck.id));
                        currentMarkers[truck.id] = marker;
                    }
                });

                if (activeTruckId) {
                    const activeTruck = trucks.find(t => t.id === activeTruckId);
                    if (activeTruck) map.setView([activeTruck.lat, activeTruck.lng], 15);
                }
            }, [trucks, activeTruckId, darkMode]);

            // Test Connection
            const testConnection = async () => {
                setDebugMsg('正在測試連線到 Zeabur Proxy...');
                try {
                    const res = await fetch(`${PROXY_BASE}?city=taipei`);
                    if (res.ok) {
                        const text = await res.text();
                        if (text.length > 50) {
                             setDebugMsg(`✅ 連線成功！\nProxy 回傳了 ${text.length} bytes 的資料。\n若地圖沒車，可能是現在垃圾車未發車。`);
                        } else {
                             setDebugMsg(`⚠️ 連線成功但資料過短 (${text.length} bytes)。\n可能是垃圾車未發車或 API 回傳空值。`);
                        }
                    } else {
                        setDebugMsg(`❌ 連線失敗: HTTP ${res.status} (${res.statusText})`);
                    }
                } catch (e) {
                    setDebugMsg(`❌ 無法連線: ${e.message}\n請檢查 Zeabur 部署狀態。`);
                }
            };

            const fetchData = async (city) => {
                setLoading(true);
                setTrucks([]);
                setDebugMsg(''); 

                if (!useRealData) {
                    setTimeout(() => {
                        setTrucks(generateMockTrucks(city));
                        setLoading(false);
                    }, 800);
                    return;
                }

                try {
                    if (city.type === 'csv') {
                        Papa.parse(city.url, {
                            download: true,
                            header: true,
                            complete: (results) => {
                                const parsed = results.data.map((row, idx) => {
                                    const lat = parseFloat(row.Lat || row.Latitude || row.Y || row.y);
                                    const lng = parseFloat(row.Lng || row.Longitude || row.X || row.x);
                                    if (isNaN(lat) || isNaN(lng)) return null;
                                    return {
                                        id: row.CarNo || row.car_no || `id-${idx}`,
                                        plate: row.CarNo || row.car_no || '未知車號',
                                        location: row.Location || '行駛中',
                                        lat, lng
                                    };
                                }).filter(Boolean);
                                setTrucks(parsed);
                                setLoading(false);
                                if (parsed.length === 0) setDebugMsg('API 連線正常，但目前回傳資料為空 (可能尚未發車)');
                            },
                            error: (err) => {
                                console.error(err);
                                setDebugMsg('CSV 解析失敗或是 Proxy 錯誤');
                                setLoading(false);
                            }
                        });
                    } else if (city.type === 'json') {
                        const res = await fetch(city.url);
                        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                        const data = await res.json();
                        let parsed = [];
                        const rawList = Array.isArray(data) ? data : (data.data || []);
                        
                        parsed = rawList.map((row, idx) => {
                            const lat = parseFloat(row.Lat || row.Latitude || row.Y || row.y);
                            const lng = parseFloat(row.Lng || row.Longitude || row.X || row.x);
                            if (isNaN(lat) || isNaN(lng)) return null;
                            return {
                                id: row.CarNo || row.car_no || `id-${idx}`,
                                plate: row.CarNo || row.car_no || '未知車號',
                                location: row.Location || '行駛中',
                                lat, lng
                            };
                        }).filter(Boolean);

                        setTrucks(parsed);
                        setLoading(false);
                        if (parsed.length === 0) setDebugMsg('API 連線正常，但目前回傳資料為空 (可能尚未發車)');
                    } else {
                        setDebugMsg('此城市僅支援網頁瀏覽，無法透過 API 取得座標');
                        setUseRealData(false);
                        setTrucks(generateMockTrucks(city));
                        setLoading(false);
                    }
                } catch (e) {
                    console.error(e);
                    setDebugMsg(`錯誤: ${e.message}`);
                    setUseRealData(false);
                    setTrucks(generateMockTrucks(city));
                    setLoading(false);
                }
            };

            const handleCitySelect = (city) => { setSelectedCity(city); fetchData(city); };
            const handleBack = () => { setSelectedCity(null); setTrucks([]); };

            return (
                <div className={`min-h-screen flex flex-col ${darkMode ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-900'}`}>
                    <header className={`p-4 shadow-md flex justify-between items-center z-20 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                        <div className="flex items-center gap-3">
                            {selectedCity && (
                                <button onClick={handleBack} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                                    <i className="fa-solid fa-arrow-left"></i>
                                </button>
                            )}
                            <h1 className="text-xl font-bold tracking-wider">
                                <i className="fa-solid fa-trash-can mr-2 text-green-500"></i>
                                {selectedCity ? `${selectedCity.name}垃圾車動態` : '城市選擇'}
                            </h1>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={() => setDarkMode(!darkMode)} className={`px-4 py-2 rounded-full font-medium transition duration-300 flex items-center gap-2 ${darkMode ? 'bg-yellow-400 text-gray-900' : 'bg-gray-800 text-white'}`}>
                                <i className={`fa-solid ${darkMode ? 'fa-sun' : 'fa-moon'}`}></i> {darkMode ? '早安' : '晚安'}
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 relative overflow-hidden flex flex-col">
                        {!selectedCity ? (
                            <div className="container mx-auto p-6 flex flex-col items-center">
                                <div className="w-full grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
                                    {CITIES.map(city => (
                                        <button key={city.id} onClick={() => handleCitySelect(city)} className={`group relative p-6 rounded-xl shadow-lg transition transform hover:-translate-y-1 hover:shadow-2xl text-left border overflow-hidden ${darkMode ? 'bg-gray-800 border-gray-700 hover:bg-gray-750' : 'bg-white border-gray-100 hover:bg-blue-50'}`}>
                                            <div className="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i className="fa-solid fa-map-location-dot text-6xl"></i></div>
                                            <h2 className="text-2xl font-bold mb-2">{city.name}</h2>
                                            <div className="mt-4 flex items-center text-xs font-mono opacity-50"><span className="bg-green-100 text-green-800 px-2 py-1 rounded dark:bg-green-900 dark:text-green-100">{city.type.toUpperCase()}</span></div>
                                        </button>
                                    ))}
                                </div>
                                
                                {/* Debug Section */}
                                <div className={`w-full max-w-2xl p-4 rounded-lg border ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
                                    <h3 className="font-bold mb-2 flex items-center gap-2"><i className="fa-solid fa-screwdriver-wrench"></i> 連線診斷工具</h3>
                                    <p className="text-sm opacity-70 mb-3">如果地圖沒有資料，請點擊下方按鈕測試伺服器狀態。</p>
                                    <div className="flex gap-2">
                                        <button onClick={testConnection} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm transition">
                                            測試 API 連線
                                        </button>
                                        <a href={`${PROXY_BASE}?city=taipei`} target="_blank" className="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm transition">
                                            直接開啟 API 連結
                                        </a>
                                    </div>
                                    {debugMsg && (
                                        <div className="mt-3 p-3 bg-black text-green-400 font-mono text-xs rounded whitespace-pre-wrap">
                                            {debugMsg}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="flex flex-col h-full relative">
                                <div className={`absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] px-4 py-2 rounded-full shadow-lg flex items-center gap-2 text-sm ${darkMode ? 'bg-gray-800/90 text-white' : 'bg-white/90 text-gray-800'} backdrop-blur-sm`}>
                                    <span className="font-bold">模式：</span>
                                    <button onClick={() => { setUseRealData(false); fetchData(selectedCity); }} className={`px-3 py-1 rounded-full transition ${!useRealData ? 'bg-green-500 text-white' : 'hover:bg-gray-200 dark:hover:bg-gray-700'}`}>模擬</button>
                                    <button onClick={() => { setUseRealData(true); fetchData(selectedCity); }} className={`px-3 py-1 rounded-full transition ${useRealData ? 'bg-green-500 text-white' : 'hover:bg-gray-200 dark:hover:bg-gray-700'}`}>真實資料</button>
                                </div>
                                <div id="map-container" className="flex-1 w-full h-full z-10"></div>
                                {loading && (
                                    <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                                        <div className="text-white text-center"><i className="fa-solid fa-circle-notch fa-spin text-4xl mb-2"></i><p>載入中...</p></div>
                                    </div>
                                )}
                                <div className={`absolute bottom-4 left-4 right-4 md:left-auto md:right-4 md:top-20 md:bottom-auto md:w-80 z-[1000] rounded-xl shadow-2xl max-h-[40vh] md:max-h-[80vh] overflow-hidden flex flex-col ${darkMode ? 'bg-gray-800/95 border border-gray-700' : 'bg-white/95 border border-gray-200'} backdrop-blur-md transition-all`}>
                                    <div className={`p-3 border-b font-bold flex justify-between items-center ${darkMode ? 'border-gray-700' : 'border-gray-100'}`}>
                                        <span>附近車輛 ({trucks.length})</span>
                                        {useRealData && <span className="text-xs text-red-500 border border-red-500 px-1 rounded">LIVE</span>}
                                        {!useRealData && <span className="text-xs text-blue-500 border border-blue-500 px-1 rounded">SIM</span>}
                                    </div>
                                    <div className="overflow-y-auto p-2 space-y-2 flex-1">
                                        {debugMsg && <div className="text-xs text-red-400 p-2 border border-red-900 bg-red-900/20 rounded">{debugMsg}</div>}
                                        {trucks.length === 0 && !loading && <div className="text-center py-4 text-gray-500 text-sm">目前沒有車輛資訊 (可能未發車)</div>}
                                        {trucks.map(truck => (
                                            <button key={truck.id} onClick={() => setActiveTruckId(truck.id)} className={`w-full text-left p-3 rounded-lg transition flex items-center gap-3 ${activeTruckId === truck.id ? 'bg-green-500 text-white shadow-lg scale-[1.02]' : (darkMode ? 'hover:bg-gray-700 bg-gray-750' : 'hover:bg-gray-50 bg-white border border-gray-100')}`}>
                                                <div className={`p-2 rounded-full ${activeTruckId === truck.id ? 'bg-white/20' : 'bg-gray-200 dark:bg-gray-900'}`}><i className="fa-solid fa-truck text-sm"></i></div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-bold truncate">{truck.plate}</div>
                                                    <div className={`text-xs truncate ${activeTruckId === truck.id ? 'text-green-100' : 'text-gray-500 dark:text-gray-400'}`}>{truck.location}</div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>